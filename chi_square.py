from xml.dom.minidom import parseString
import xlsxwriter , csv
import sys , string
import re , operator
import glob , os , math


#running syntax
#
# python chisquare.py <Raw> <chidata.txt>

chi_score = [0] * 50000  #have length of features ie len(data[i])
A = [0] * 50000
B = [0] * 50000
C = [0] * 50000
D = [0] * 50000
num = 0
denominator = [0] * 50000
numerator = [0] * 50000

def read_data():
	with open(sys.argv[1] , "r") as f:
		reader = csv.reader(f)
		data = list(reader)
		return data
	
#sys.argv[1] is the command line argument where you pass the number of applications you want to score with
def chi_score_setup(data):
	for j in range(0,len(data[1])-1):
		num = 0
		for i in range(1,len(data)):
			if float(data[i][j]) == 1:
				if float(data[i][len(data) - 1]) == 1:		#1 is benign
					A[j] +=1
					num += 1
				else:
					B[j] +=1
					num += 1
			else:
				if float(data[i][len(data) - 1]) == 1:		#1 is benign
					C[j] +=1
					num += 1
				else:
					D[j] +=1
					num += 1
		
		numerator[j] = float(((A[j] * D[j]) - (B[j] * C[j])) * num * num)
		denominator[j] = float((A[j] + B[j]) * (C[j] + D[j]) * (A[j] + C[j]) * (B[j] + D[j]))
		if(denominator[j] == 0):
			print "test"
			chi_score[j] = -1
		else:
			chi_score[j] = abs(float(numerator[j] / denominator[j]))



def write_into_set(data,filename):
	samplist = list()
	for i in range(0,len(data[1]) - 1):
		samplist.append(str(chi_score[i]))

	#print samplist
	with open(filename,"w") as f:
		for sam in samplist:
			f.write(sam)
			f.write(",")
		

		
count = 0
data = read_data()


#print len(data)
#print len(data[1])
chi_score_setup(data)
### dataset is made in the raw form and further alterations made by running the above module will cause dataset to fail

write_into_set(data,"chi_score.txt")

selected = list()

for i in range(len(data[0])):
	if float(chi_score[i]) != 1.00050018756:
		selected.append(i)
print len(selected)

new_dataset = list()

for dat in data: # dat is the line(apk) withing in the dataset that is data
	f_v = list()
	for j in range(len(selected)):
		f_v.append(dat[selected[j]])
	f_v.pop()
	new_dataset.append(f_v)


#new dataset made has 2000 beniign and 2000 malicious
# print len(new_dataset)
# print len(new_dataset[0])
# print new_dataset[1][len(new_dataset[0]) - 1]
# # counti =0 
# # for i in range(1,len(new_dataset) - 1):
# # 	if float(new_dataset[i][len(new_dataset[i]) - 1]) == float(1):
# # 		counti += 1
 
# # print counti
def createDataSet(new_dataset):
	with open(sys.argv[2] , "w") as f:
		writer = csv.writer(f)
		for data in new_dataset:
			for datum in data:
				f.write(datum)
				f.write(",")
			f.write("\n")
	
	f.close()
new_dataset.pop()
createDataSet(new_dataset)
#sum = 0
#for j in range(1,len(data)):
#	sum = sum + 1
#print sum
#print len(data)
#print len(data[1])
#print data[1][len(data[2]) - 2]